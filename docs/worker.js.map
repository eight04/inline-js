{"version":3,"file":"worker.js","sources":["../src/worker.js"],"sourcesContent":["/* eslint-env browser */\r\nimport {writeFileSync, unlinkSync} from \"fs\";\r\nimport dataUriToBuffer from \"data-uri-to-buffer\";\r\nimport {createDefaultInliner, buildDependency} from \"..\";\r\n\r\nasync function withFiles(files, onReady) {\r\n  try {\r\n    files.forEach(file => {\r\n      if (file.type === \"text\") {\r\n        writeFileSync(file.name, file.data, {flag: \"wx\"});\r\n      } else {\r\n        writeFileSync(file.name, dataUriToBuffer(file.data), {flag: \"wx\"});\r\n      }\r\n    });\r\n    return await onReady();\r\n  } finally {\r\n    files.forEach(file => {\r\n      try {\r\n        unlinkSync(file.name);\r\n      } catch (err) {\r\n        // pass\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nself.addEventListener(\"message\", e => {\r\n  const ts = performance.now();\r\n  Promise.resolve()\r\n    .then(() => withFiles(\r\n      e.data.files,\r\n      () => {\r\n        const inliner = createDefaultInliner();\r\n        return inliner.inline({name: \"text\", args: [e.data.files[0].name]});\r\n      }\r\n    ))\r\n    .then(({content, children}) => ({\r\n      requestId: e.data.requestId,\r\n      error: false,\r\n      data: {\r\n        content,\r\n        dependency: buildDependency(e.data.files[0].name, children),\r\n        timeout: performance.now() - ts\r\n      }\r\n    }))\r\n    .catch(err => ({\r\n      requestId: e.data.requestId,\r\n      error: true,\r\n      data: err.message\r\n    }))\r\n    .then(message => self.postMessage(message));\r\n});\r\n"],"names":["async","withFiles","files","onReady","forEach","file","type","writeFileSync","name","data","flag","dataUriToBuffer","unlinkSync","err","self","addEventListener","e","ts","performance","now","Promise","resolve","then","createDefaultInliner","inline","args","content","children","requestId","error","dependency","buildDependency","timeout","catch","message","postMessage"],"mappings":"8IAKAA,eAAeC,UAAUC,EAAOC,GAC9B,IAQE,OAPAD,EAAME,QAAQC,IACM,SAAdA,EAAKC,KACPC,cAAcF,EAAKG,KAAMH,EAAKI,MAAOC,KAAM,OAE3CH,cAAcF,EAAKG,KAAMG,gBAAgBN,EAAKI,OAAQC,KAAM,eAGnDP,YAEbD,EAAME,QAAQC,IACZ,IACEO,WAAWP,EAAKG,MAChB,MAAOK,QAOfC,KAAKC,iBAAiB,UAAWC,IAC/B,MAAMC,EAAKC,YAAYC,MACvBC,QAAQC,UACLC,KAAK,IAAMrB,UACVe,EAAEP,KAAKP,MACP,KAEE,OADgBqB,uBACDC,QAAQhB,KAAM,OAAQiB,MAAOT,EAAEP,KAAKP,MAAM,GAAGM,WAG/Dc,KAAK,EAAEI,QAAAA,EAASC,SAAAA,OACfC,UAAWZ,EAAEP,KAAKmB,UAClBC,OAAO,EACPpB,MACEiB,QAAAA,EACAI,WAAYC,gBAAgBf,EAAEP,KAAKP,MAAM,GAAGM,KAAMmB,GAClDK,QAASd,YAAYC,MAAQF,MAGhCgB,MAAMpB,KACLe,UAAWZ,EAAEP,KAAKmB,UAClBC,OAAO,EACPpB,KAAMI,EAAIqB,WAEXZ,KAAKY,GAAWpB,KAAKqB,YAAYD"}